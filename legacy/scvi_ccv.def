Bootstrap: docker
From: pytorch/pytorch:2.3.1-cuda12.1-cudnn8-runtime

%labels
    Maintainer gchoudha@brown.edu
    Description Combined R + Python environment (Seurat + scVI + Scrublet) for CCV

%post
    set -eux
    export DEBIAN_FRONTEND=noninteractive

    # --- base tools + enable CRAN repo for R ---
    apt-get update
    apt-get install -y --no-install-recommends \
        software-properties-common dirmngr gnupg ca-certificates curl locales \
        build-essential pkg-config python3-pip python3-dev git

    curl -fsSL https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc \
      | gpg --dearmor -o /usr/share/keyrings/cran-archive-keyring.gpg

    echo "deb [signed-by=/usr/share/keyrings/cran-archive-keyring.gpg] \
https://cloud.r-project.org/bin/linux/ubuntu jammy-cran40/" \
      > /etc/apt/sources.list.d/cran-r.list

    apt-get update
    apt-get install -y --no-install-recommends \
        r-base r-base-dev littler \
        libcurl4-openssl-dev libssl-dev libxml2-dev \
        libhdf5-dev zlib1g-dev libbz2-dev liblzma-dev libzstd-dev \
        libreadline-dev libpcre2-dev \
        libfftw3-dev libtiff-dev libpng-dev libjpeg-dev \
        pandoc

    locale-gen en_US.UTF-8 || true
    mkdir -p /opt/R/site-library && chmod -R 777 /opt/R/site-library

    # --- Python stack (Torch-only) ---
    python3 -m pip install --upgrade pip wheel setuptools

python3 -m pip install --no-cache-dir \
  scanpy==1.10.3 anndata==0.10.9 numpy==1.26.4 pandas==2.2.3 \
  scikit-learn==1.5.2 scipy==1.13.1 umap-learn==0.5.6 \
  matplotlib==3.9.2 scrublet==0.2.3 \
  torch==2.3.1 \
  lightning==2.1.4 pytorch-lightning==2.1.4 \
 "rich>=13,<15" \
  ipywidgets==8.1.8 ipykernel==6.29.5 jupyterlab==4.2.5

    python3 -m pip install --no-cache-dir --only-binary=:all: "annoy==1.17.3" || \
    python3 -m pip install --no-cache-dir "annoy==1.17.3"

    python3 -m pip install --no-cache-dir --no-deps "scvi-tools==1.1.5"

    # --- R packages (Seurat, conversion tools, IRkernel) ---
    echo 'options(repos=c(CRAN="https://cloud.r-project.org"))' >> /etc/R/Rprofile.site
    Rscript -e 'install.packages(c("Seurat","SeuratDisk","qs","reticulate","IRkernel"))'
    Rscript -e 'if(!requireNamespace("BiocManager", quietly=TRUE)) install.packages("BiocManager"); BiocManager::install(c("SingleCellExperiment","zellkonverter","HDF5Array","rhdf5"), update=FALSE, ask=FALSE)'
    Rscript -e 'IRkernel::installspec(name="ir", displayname="R (IRkernel)")'

    # --- Sanity check ---
    python3 - <<'PY'
import torch, scanpy as sc, scvi, scrublet, lightning
from lightning.pytorch import seed_everything
print("Torch:", torch.__version__, "CUDA:", torch.cuda.is_available())
print("scanpy:", sc.__version__, "scvi-tools:", scvi.__version__, "scrublet:", scrublet.__version__, "lightning:", lightning.__version__)
PY
    Rscript -e 'sessionInfo(); cat("\\n[OK] R + IRkernel installed\\n")'

    # --- cleanup ---
    python3 -m pip cache purge || true
    rm -rf /root/.cache/pip
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export MPLBACKEND=Agg
    export SCVI_BACKEND=PYTORCH

%runscript
    exec jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root
