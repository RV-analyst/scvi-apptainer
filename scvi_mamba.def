Bootstrap: docker
From: pytorch/pytorch:2.3.1-cuda12.1-cudnn8-runtime

%labels
    Maintainer gchoudha@brown.edu
    Description CCV image: scVI/Scanpy + Jupyter (CUDA 12.1), micromamba-managed (no R)

%files
    environment.yml /opt/stack/environment.yml

%post
    set -eux
    export DEBIAN_FRONTEND=noninteractive

    # --- Minimal OS deps + conveniences ---
    apt-get update
    apt-get install -y --no-install-recommends \
      ca-certificates curl git locales \
      tini && \
    rm -rf /var/lib/apt/lists/*
    locale-gen en_US.UTF-8 || true

    # --- Micromamba (single binary) ---
    curl -L https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xvj bin/micromamba
    install -m 0755 bin/micromamba /usr/local/bin/micromamba
    rm -rf bin
    mkdir -p /opt/conda
    export MAMBA_ROOT_PREFIX=/opt/conda

    # --- Create Python env from pinned YAML ---
    micromamba create -y -p /opt/conda/envs/scvi -f /opt/stack/environment.yml
    micromamba run -p /opt/conda/envs/scvi python -m ipykernel install --name scvi --display-name "Python (scvi)"

    # --- Quick smoke test (no scvi import to keep build robust) ---
    micromamba run -p /opt/conda/envs/scvi python - <<'PY'
import torch, scanpy as sc
print("Torch:", torch.__version__, "CUDA:", torch.cuda.is_available(), "| Scanpy:", sc.__version__)
PY

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export MPLBACKEND=Agg
    export MAMBA_ROOT_PREFIX=/opt/conda
    export PATH=/opt/conda/envs/scvi/bin:$PATH
    export SCVI_BACKEND=PYTORCH

%runscript
    exec /usr/bin/tini -- jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root
