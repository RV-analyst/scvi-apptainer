Bootstrap: docker
From: pytorch/pytorch:2.3.1-cuda12.1-cudnn8-runtime

%labels
    Maintainer gchoudha@brown.edu
    Description CCV image: scVI/Scanpy + R (Seurat) + Jupyter (CUDA 12.1), micromamba-managed

%files
    environment.yml /opt/stack/environment.yml

%post
    set -eux
    export DEBIAN_FRONTEND=noninteractive

    # --- Base tools + CRAN for R ---
    apt-get update
    apt-get install -y --no-install-recommends \
      software-properties-common dirmngr gnupg ca-certificates curl locales \
      build-essential pkg-config python3-pip python3-dev git
    curl -fsSL https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc \
      | gpg --dearmor -o /usr/share/keyrings/cran-archive-keyring.gpg
    echo "deb [signed-by=/usr/share/keyrings/cran-archive-keyring.gpg] https://cloud.r-project.org/bin/linux/ubuntu jammy-cran40/" \
      > /etc/apt/sources.list.d/cran-r.list
    apt-get update
    apt-get install -y --no-install-recommends \
      r-base-core r-base r-base-dev littler \
      libcurl4-openssl-dev libssl-dev libxml2-dev \
      libhdf5-dev zlib1g-dev libbz2-dev liblzma-dev libzstd-dev \
      libreadline-dev libpcre2-dev \
      libfftw3-dev libtiff-dev libpng-dev libjpeg-dev \
      pandoc
    locale-gen en_US.UTF-8 || true
    mkdir -p /opt/R/site-library && chmod -R 777 /opt/R/site-library

    # --- Verify R is present before using it ---
    echo "[which R]"; which R || true
    echo "[which Rscript]"; which Rscript || true
    /usr/bin/R --version
    /usr/bin/Rscript --version
    test -x /usr/bin/Rscript || (echo "[ERROR] Rscript missing after install"; apt-cache policy r-base r-base-core; exit 1)

    # --- Micromamba installer (single binary) ---
    curl -L https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xvj bin/micromamba
    install -m 0755 bin/micromamba /usr/local/bin/micromamba
    rm -rf bin
    mkdir -p /opt/conda && chown -R root:root /opt/conda
    export MAMBA_ROOT_PREFIX=/opt/conda

    # --- Create env from environment.yml ---
    micromamba create -y -p /opt/conda/envs/scvi -f /opt/stack/environment.yml
    micromamba run -p /opt/conda/envs/scvi python -m ipykernel install --name scvi --display-name "Python (scvi)"

    # --- R packages + IRkernel (CRAN + Bioc) ---
    echo 'options(repos=c(CRAN="https://cloud.r-project.org"))' >> /etc/R/Rprofile.site
    /usr/bin/Rscript -e 'install.packages(c("Seurat","SeuratDisk","qs","reticulate","IRkernel"), Ncpus = max(1, parallel::detectCores()-1))'
    /usr/bin/Rscript -e 'if(!requireNamespace("BiocManager", quietly=TRUE)) install.packages("BiocManager"); BiocManager::install(c("SingleCellExperiment","zellkonverter","HDF5Array","rhdf5"), update=FALSE, ask=FALSE)'
    /usr/bin/Rscript -e 'IRkernel::installspec(name="ir", displayname="R (IRkernel)")'

    # --- Quick smoke test (no scvi import here) ---
    micromamba run -p /opt/conda/envs/scvi python - <<'PY'
import torch, scanpy as sc
print("Torch:", torch.__version__, "CUDA:", torch.cuda.is_available(), "| Scanpy:", sc.__version__)
PY

    # Cleanup
    apt-get clean && rm -rf /var/lib/apt/lists/*
    micromamba clean -a -y || true

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export MPLBACKEND=Agg
    export MAMBA_ROOT_PREFIX=/opt/conda
    export PATH=/opt/conda/envs/scvi/bin:$PATH
    export SCVI_BACKEND=PYTORCH

%runscript
    exec jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root
